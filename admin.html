<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | JMECH GROUP</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="stylesheet" href="style.css"> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-box { border: 1px solid #ddd; padding: 30px; margin-bottom: 30px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .project-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .delete-btn { background: transparent; color: red; border: 1px solid red; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; }
        .delete-btn:hover { background: red; color: white; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container nav-flex">
            <a href="index.html" class="logo-link"><div class="logo"><img src="logo.jpg" alt="JMECH GROUP" style="height: 70px; width: auto;"></div></a>
            <nav id="nav-menu"><a href="index.html">View Site</a><a href="gallery.html">View Gallery</a></nav>
        </div>
    </header>

    <section class="section-padding bg-grey">
        <div class="container">
            <div class="section-header"><h2>Admin Dashboard</h2></div>

            <div id="login-section" class="admin-box" style="max-width: 400px; margin: 0 auto;">
                <h3 style="margin-bottom: 20px;">Authorized Access Only</h3>
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Password">
                <button onclick="login()" class="btn btn-primary" style="width: 100%;">Login</button>
            </div>

            <div id="admin-panel" style="display:none;">
                <div class="admin-box">
                    <h3 style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Update Owner Photo</h3>
                    <input type="file" id="owner-image">
                    <button onclick="uploadOwner()" class="btn btn-primary">Update Photo</button>
                </div>
                <div class="admin-box">
                    <h3 style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Add New Project</h3>
                    <input type="text" id="project-title" placeholder="Project Title">
                    <select id="project-category">
                        <option value="Maintenance">Maintenance</option>
                        <option value="Installation">Installation</option>
                        <option value="Repairs">Repairs</option>
                    </select>
                    <input type="file" id="project-image">
                    <button onclick="uploadProject()" class="btn btn-primary">+ Upload Project</button>
                </div>
                <div class="admin-box">
                    <h3 style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Manage Projects</h3>
                    <div id="project-list">Loading...</div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // FIXED URL (Removed the extra 'c')
        const SUPABASE_URL = "https://zypuzywbcswjdnnrktan.supabase.co";
        
        // PASTE YOUR LONG KEY HERE
        const SUPABASE_KEY = "PASTE_YOUR_LONG_KEY_HERE"; 

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await client.auth.signInWithPassword({ email, password });
            if (error) {
                console.error(error);
                alert("Login Failed: " + error.message);
            } else {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                fetchProjects();
            }
        }

        async function uploadOwner() {
            const file = document.getElementById('owner-image').files[0];
            if(!file) return alert("Select file first");
            await client.storage.from('jmech-assets').upload('owner.png', file, { upsert: true, cacheControl: '0' });
            alert("Owner Photo Updated! (Refresh home page to see)");
        }

        async function uploadProject() {
            const title = document.getElementById('project-title').value;
            const cat = document.getElementById('project-category').value;
            const file = document.getElementById('project-image').files[0];
            if(!file || !title) return alert("Missing fields");

            const fileName = `proj-${Date.now()}.png`;
            await client.storage.from('jmech-assets').upload(fileName, file);
            const { data } = client.storage.from('jmech-assets').getPublicUrl(fileName);
            
            await client.from('projects').insert([{ title: title, category: cat, image_url: data.publicUrl }]);
            alert("Project Added!");
            fetchProjects();
        }

        async function fetchProjects() {
            const div = document.getElementById('project-list');
            const { data } = await client.from('projects').select('*').order('created_at', {ascending: false});
            div.innerHTML = "";
            if(!data || data.length === 0) {
                div.innerHTML = "No projects found.";
                return;
            }
            data.forEach(p => {
                div.innerHTML += `<div class="project-item"><span><b>${p.title}</b> <small>(${p.category})</small></span><button class="delete-btn" onclick="del('${p.id}')">DELETE</button></div>`;
            });
        }

        async function del(id) {
            if(confirm("Delete this project?")) {
                await client.from('projects').delete().eq('id', id);
                fetchProjects();
            }
        }
    </script>
</body>
</html>
